time="2025-11-02T19:56:47+04:00" level=warning msg="/Users/sedmahdiyar/Desktop/Minila/backend/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
============================= test session starts ==============================
platform linux -- Python 3.12.11, pytest-8.3.5, pluggy-1.6.0 -- /usr/local/bin/python3.12
cachedir: .pytest_cache
rootdir: /app
plugins: Faker-37.12.0, cov-7.0.0, anyio-4.11.0, asyncio-0.23.8
asyncio: mode=Mode.STRICT
collecting ... collected 93 items

tests/api/test_auth.py::TestSignup::test_signup_success FAILED           [  1%]
tests/api/test_auth.py::TestSignup::test_signup_duplicate_email PASSED   [  2%]
tests/api/test_auth.py::TestSignup::test_signup_invalid_email PASSED     [  3%]
tests/api/test_auth.py::TestSignup::test_signup_missing_required_field PASSED [  4%]
tests/api/test_auth.py::TestSignup::test_signup_empty_password PASSED    [  5%]
tests/api/test_auth.py::TestRequestOTP::test_request_otp_success FAILED  [  6%]
tests/api/test_auth.py::TestRequestOTP::test_request_otp_nonexistent_user PASSED [  7%]
tests/api/test_auth.py::TestRequestOTP::test_request_otp_invalid_email PASSED [  8%]
tests/api/test_auth.py::TestRequestOTP::test_request_otp_updates_existing_code FAILED [  9%]
tests/api/test_auth.py::TestVerifyOTP::test_verify_otp_success FAILED    [ 10%]
tests/api/test_auth.py::TestVerifyOTP::test_verify_otp_wrong_code PASSED [ 11%]
tests/api/test_auth.py::TestVerifyOTP::test_verify_otp_used_code FAILED  [ 12%]
tests/api/test_auth.py::TestVerifyOTP::test_verify_otp_nonexistent_user PASSED [ 13%]
tests/api/test_auth.py::TestVerifyOTP::test_verify_otp_invalid_email_format PASSED [ 15%]
tests/api/test_auth.py::TestRefreshToken::test_refresh_token_success FAILED [ 16%]
tests/api/test_auth.py::TestRefreshToken::test_refresh_token_invalid PASSED [ 17%]
tests/api/test_auth.py::TestRefreshToken::test_refresh_token_expired PASSED [ 18%]
tests/api/test_cards.py::TestGetCards::test_get_cards_with_pagination ERROR [ 19%]
tests/api/test_cards.py::TestGetCards::test_get_cards_filter_origin_city ERROR [ 20%]
tests/api/test_cards.py::TestGetCards::test_get_cards_filter_destination_city ERROR [ 21%]
tests/api/test_cards.py::TestGetCards::test_get_cards_filter_is_sender_true FAILED [ 22%]
tests/api/test_cards.py::TestGetCards::test_get_cards_filter_is_sender_false ERROR [ 23%]
tests/api/test_cards.py::TestGetCards::test_get_cards_multiple_filters ERROR [ 24%]
tests/api/test_cards.py::TestCreateCard::test_create_passenger_card_success FAILED [ 25%]
tests/api/test_cards.py::TestCreateCard::test_create_sender_card_success FAILED [ 26%]
tests/api/test_cards.py::TestCreateCard::test_create_card_without_auth PASSED [ 27%]
tests/api/test_cards.py::TestCreateCard::test_create_card_validation_error PASSED [ 29%]
tests/api/test_cards.py::TestCreateCard::test_create_card_with_community_ids ERROR [ 30%]
tests/api/test_cards.py::TestGetCard::test_get_card_success ERROR        [ 31%]
tests/api/test_cards.py::TestGetCard::test_get_card_not_found PASSED     [ 32%]
tests/api/test_cards.py::TestUpdateCard::test_update_card_by_owner ERROR [ 33%]
tests/api/test_cards.py::TestUpdateCard::test_update_card_by_non_owner ERROR [ 34%]
tests/api/test_cards.py::TestUpdateCard::test_update_card_without_auth ERROR [ 35%]
tests/api/test_cards.py::TestUpdateCard::test_update_card_not_found PASSED [ 36%]
tests/api/test_cards.py::TestDeleteCard::test_delete_card_by_owner FAILED [ 37%]
tests/api/test_cards.py::TestDeleteCard::test_delete_card_by_non_owner ERROR [ 38%]
tests/api/test_cards.py::TestDeleteCard::test_delete_card_without_auth ERROR [ 39%]
tests/api/test_cards.py::TestDeleteCard::test_delete_card_not_found PASSED [ 40%]
tests/api/test_communities.py::TestGetCommunities::test_get_communities_empty_list PASSED [ 41%]
tests/api/test_communities.py::TestGetCommunities::test_get_communities_with_data ERROR [ 43%]
tests/api/test_communities.py::TestGetCommunities::test_get_communities_pagination ERROR [ 44%]
tests/api/test_communities.py::TestCreateCommunity::test_create_community_success FAILED [ 45%]
tests/api/test_communities.py::TestCreateCommunity::test_create_community_duplicate_name ERROR [ 46%]
tests/api/test_communities.py::TestCreateCommunity::test_create_community_without_auth PASSED [ 47%]
tests/api/test_communities.py::TestCreateCommunity::test_create_community_validation_error PASSED [ 48%]
tests/api/test_communities.py::TestGetCommunity::test_get_community_success ERROR [ 49%]
tests/api/test_communities.py::TestGetCommunity::test_get_community_not_found PASSED [ 50%]
tests/api/test_communities.py::TestUpdateCommunity::test_update_community_by_owner ERROR [ 51%]
tests/api/test_communities.py::TestUpdateCommunity::test_update_community_by_non_owner ERROR [ 52%]
tests/api/test_communities.py::TestUpdateCommunity::test_update_community_without_auth ERROR [ 53%]
tests/api/test_communities.py::TestUpdateCommunity::test_update_community_not_found PASSED [ 54%]
tests/api/test_communities.py::TestJoinCommunity::test_join_community_success ERROR [ 55%]
tests/api/test_communities.py::TestJoinCommunity::test_join_community_duplicate_request ERROR [ 56%]
tests/api/test_communities.py::TestJoinCommunity::test_join_community_not_found FAILED [ 58%]
tests/api/test_communities.py::TestJoinCommunity::test_join_community_without_auth ERROR [ 59%]
tests/api/test_communities.py::TestGetJoinRequests::test_get_requests_by_owner ERROR [ 60%]
tests/api/test_communities.py::TestGetJoinRequests::test_get_requests_by_non_owner ERROR [ 61%]
tests/api/test_communities.py::TestGetJoinRequests::test_get_requests_without_auth ERROR [ 62%]
tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_success ERROR [ 63%]
tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_by_non_owner ERROR [ 64%]
tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_not_found ERROR [ 65%]
tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_without_auth ERROR [ 66%]
tests/api/test_communities.py::TestRejectJoinRequest::test_reject_request_success ERROR [ 67%]
tests/api/test_communities.py::TestRejectJoinRequest::test_reject_request_by_non_owner ERROR [ 68%]
tests/api/test_communities.py::TestRejectJoinRequest::test_reject_request_without_auth ERROR [ 69%]
tests/api/test_communities.py::TestGetCommunityMembers::test_get_members_with_pagination ERROR [ 70%]
tests/api/test_communities.py::TestGetCommunityMembers::test_get_members_only_active ERROR [ 72%]
tests/api/test_communities.py::TestGetCommunityMembers::test_get_members_not_found FAILED [ 73%]
tests/api/test_messages.py::TestSendMessage::test_send_message_success_with_common_community ERROR [ 74%]
tests/api/test_messages.py::TestSendMessage::test_send_message_blocked_no_common_community ERROR [ 75%]
tests/api/test_messages.py::TestSendMessage::test_send_message_rate_limit_exceeded ERROR [ 76%]
tests/api/test_messages.py::TestSendMessage::test_send_message_without_auth PASSED [ 77%]
tests/api/test_messages.py::TestSendMessage::test_send_message_validation_error_missing_body FAILED [ 78%]
tests/api/test_messages.py::TestSendMessage::test_send_message_validation_error_empty_body FAILED [ 79%]
tests/api/test_messages.py::TestSendMessage::test_send_message_to_nonexistent_user FAILED [ 80%]
tests/api/test_messages.py::TestGetInbox::test_get_inbox_with_messages ERROR [ 81%]
tests/api/test_messages.py::TestGetInbox::test_get_inbox_only_received_messages ERROR [ 82%]
tests/api/test_messages.py::TestGetInbox::test_get_inbox_newest_first ERROR [ 83%]
tests/api/test_messages.py::TestGetInbox::test_get_inbox_without_auth PASSED [ 84%]
tests/api/test_messages.py::TestGetSent::test_get_sent_with_messages ERROR [ 86%]
tests/api/test_messages.py::TestGetSent::test_get_sent_only_sent_messages ERROR [ 87%]
tests/api/test_messages.py::TestGetSent::test_get_sent_newest_first ERROR [ 88%]
tests/api/test_messages.py::TestGetSent::test_get_sent_without_auth PASSED [ 89%]
tests/api/test_users.py::TestGetMyProfile::test_get_profile_success FAILED [ 90%]
tests/api/test_users.py::TestGetMyProfile::test_get_profile_without_auth PASSED [ 91%]
tests/api/test_users.py::TestGetMyProfile::test_get_profile_invalid_token PASSED [ 92%]
tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_all_fields FAILED [ 93%]
tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_partial FAILED [ 94%]
tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_without_auth PASSED [ 95%]
tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_invalid_data PASSED [ 96%]
tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_check_updated_at FAILED [ 97%]
tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_empty_payload FAILED [ 98%]
tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_with_null_values FAILED [100%]

==================================== ERRORS ====================================
________ ERROR at setup of TestGetCards.test_get_cards_with_pagination _________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 51, 86906), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_______ ERROR at setup of TestGetCards.test_get_cards_filter_origin_city _______
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 51, 409486), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
____ ERROR at setup of TestGetCards.test_get_cards_filter_destination_city _____
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 51, 686478), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_____ ERROR at setup of TestGetCards.test_get_cards_filter_is_sender_false _____
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 265675), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________ ERROR at setup of TestGetCards.test_get_cards_multiple_filters ________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 542503), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_____ ERROR at setup of TestCreateCard.test_create_card_with_community_ids _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____________ ERROR at setup of TestGetCard.test_get_card_success ______________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 53, 810942), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
__________ ERROR at setup of TestUpdateCard.test_update_card_by_owner __________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 54, 207356), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________ ERROR at setup of TestUpdateCard.test_update_card_by_non_owner ________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 54, 530228), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________ ERROR at setup of TestUpdateCard.test_update_card_without_auth ________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 54, 804680), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________ ERROR at setup of TestDeleteCard.test_delete_card_by_non_owner ________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 55, 445318), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________ ERROR at setup of TestDeleteCard.test_delete_card_without_auth ________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:374: in test_card
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 55, 724179), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Test card for unit tests'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_____ ERROR at setup of TestGetCommunities.test_get_communities_with_data ______
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____ ERROR at setup of TestGetCommunities.test_get_communities_pagination _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
__ ERROR at setup of TestCreateCommunity.test_create_community_duplicate_name __
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
________ ERROR at setup of TestGetCommunity.test_get_community_success _________
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____ ERROR at setup of TestUpdateCommunity.test_update_community_by_owner _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
___ ERROR at setup of TestUpdateCommunity.test_update_community_by_non_owner ___
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
___ ERROR at setup of TestUpdateCommunity.test_update_community_without_auth ___
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_______ ERROR at setup of TestJoinCommunity.test_join_community_success ________
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
__ ERROR at setup of TestJoinCommunity.test_join_community_duplicate_request ___
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____ ERROR at setup of TestJoinCommunity.test_join_community_without_auth _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_______ ERROR at setup of TestGetJoinRequests.test_get_requests_by_owner _______
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____ ERROR at setup of TestGetJoinRequests.test_get_requests_by_non_owner _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____ ERROR at setup of TestGetJoinRequests.test_get_requests_without_auth _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
____ ERROR at setup of TestApproveJoinRequest.test_approve_request_success _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
__ ERROR at setup of TestApproveJoinRequest.test_approve_request_by_non_owner __
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
___ ERROR at setup of TestApproveJoinRequest.test_approve_request_not_found ____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
__ ERROR at setup of TestApproveJoinRequest.test_approve_request_without_auth __
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____ ERROR at setup of TestRejectJoinRequest.test_reject_request_success ______
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
___ ERROR at setup of TestRejectJoinRequest.test_reject_request_by_non_owner ___
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
___ ERROR at setup of TestRejectJoinRequest.test_reject_request_without_auth ___
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
__ ERROR at setup of TestGetCommunityMembers.test_get_members_with_pagination __
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
____ ERROR at setup of TestGetCommunityMembers.test_get_members_only_active ____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_ ERROR at setup of TestSendMessage.test_send_message_success_with_common_community _
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_ ERROR at setup of TestSendMessage.test_send_message_blocked_no_common_community _
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
___ ERROR at setup of TestSendMessage.test_send_message_rate_limit_exceeded ____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_________ ERROR at setup of TestGetInbox.test_get_inbox_with_messages __________
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
_____ ERROR at setup of TestGetInbox.test_get_inbox_only_received_messages _____
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
__________ ERROR at setup of TestGetInbox.test_get_inbox_newest_first __________
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
__________ ERROR at setup of TestGetSent.test_get_sent_with_messages ___________
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
________ ERROR at setup of TestGetSent.test_get_sent_only_sent_messages ________
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
___________ ERROR at setup of TestGetSent.test_get_sent_newest_first ___________
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:369: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
/usr/local/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
/usr/local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:364: in setup
    res = await func(
tests/conftest.py:238: in test_community
    from app.models.role import MembershipRole
E   ImportError: cannot import name 'MembershipRole' from 'app.models.role' (/app/app/models/role.py)
=================================== FAILURES ===================================
________________________ TestSignup.test_signup_success ________________________
tests/api/test_auth.py:28: in test_signup_success
    assert response.status_code == 201
E   assert 400 == 201
E    +  where 400 = <Response [400 Bad Request]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:49,321 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-11-02 15:56:49,321 INFO sqlalchemy.engine.Engine [raw sql] {}
2025-11-02 15:56:49,322 INFO sqlalchemy.engine.Engine select current_schema()
2025-11-02 15:56:49,322 INFO sqlalchemy.engine.Engine [raw sql] {}
2025-11-02 15:56:49,322 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2025-11-02 15:56:49,322 INFO sqlalchemy.engine.Engine [raw sql] {}
2025-11-02 15:56:49,323 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:49,335 INFO sqlalchemy.engine.Engine SELECT "user".id 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:49,335 INFO sqlalchemy.engine.Engine [generated in 0.00008s] {'email_1': 'newuser@example.com'}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:1846 select pg_catalog.version()
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] {}
INFO     sqlalchemy.engine.Engine:base.py:1846 select current_schema()
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] {}
INFO     sqlalchemy.engine.Engine:base.py:1846 show standard_conforming_strings
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] {}
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".id 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00008s] {'email_1': 'newuser@example.com'}
--------------------------- Captured stdout teardown ---------------------------
2025-11-02 15:56:49,349 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown -----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
___________________ TestRequestOTP.test_request_otp_success ____________________
tests/api/test_auth.py:139: in test_request_otp_success
    assert user.otp_code is not None
E   assert None is not None
E    +  where None = <User(id=1, email=testuser@example.com)>.otp_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:49,858 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:49,859 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:49,859 INFO sqlalchemy.engine.Engine [generated in 0.00006s] {'email_1': 'testuser@example.com'}
2025-11-02 15:56:49,860 INFO sqlalchemy.engine.Engine UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:49,861 INFO sqlalchemy.engine.Engine [generated in 0.00005s] {'otp_code': '501898', 'email_1': 'testuser@example.com'}
2025-11-02 15:56:49,862 INFO sqlalchemy.engine.Engine INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
2025-11-02 15:56:49,862 INFO sqlalchemy.engine.Engine [generated in 0.00005s] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
2025-11-02 15:56:49 - minila - INFO - Event logged: login_attempt
2025-11-02 15:56:49,862 INFO sqlalchemy.engine.Engine COMMIT
2025-11-02 15:56:49 - minila - INFO - Email sent successfully to testuser@example.com
2025-11-02 15:56:49 - minila - INFO - OTP requested for: testuser@example.com
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00006s] {'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00005s] {'otp_code': '501898', 'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00005s] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
INFO     minila:log_service.py:63 Event logged: login_attempt
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
INFO     minila:email.py:49 Email sent successfully to testuser@example.com
INFO     minila:auth_service.py:138 OTP requested for: testuser@example.com
____________ TestRequestOTP.test_request_otp_updates_existing_code _____________
tests/api/test_auth.py:198: in test_request_otp_updates_existing_code
    assert first_otp != second_otp
E   assert None != None
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:50,163 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:50,163 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,163 INFO sqlalchemy.engine.Engine [cached since 0.3038s ago] {'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,164 INFO sqlalchemy.engine.Engine UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,164 INFO sqlalchemy.engine.Engine [cached since 0.3034s ago] {'otp_code': '726382', 'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,164 INFO sqlalchemy.engine.Engine INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
2025-11-02 15:56:50,164 INFO sqlalchemy.engine.Engine [cached since 0.3028s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
2025-11-02 15:56:50 - minila - INFO - Event logged: login_attempt
2025-11-02 15:56:50,165 INFO sqlalchemy.engine.Engine COMMIT
2025-11-02 15:56:50 - minila - INFO - Email sent successfully to testuser@example.com
2025-11-02 15:56:50 - minila - INFO - OTP requested for: testuser@example.com
2025-11-02 15:56:50,168 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:50,168 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,168 INFO sqlalchemy.engine.Engine [cached since 0.3089s ago] {'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,169 INFO sqlalchemy.engine.Engine UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,169 INFO sqlalchemy.engine.Engine [cached since 0.3084s ago] {'otp_code': '637487', 'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,169 INFO sqlalchemy.engine.Engine INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
2025-11-02 15:56:50,169 INFO sqlalchemy.engine.Engine [cached since 0.3077s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
2025-11-02 15:56:50 - minila - INFO - Event logged: login_attempt
2025-11-02 15:56:50,169 INFO sqlalchemy.engine.Engine COMMIT
2025-11-02 15:56:50 - minila - INFO - Email sent successfully to testuser@example.com
2025-11-02 15:56:50 - minila - INFO - OTP requested for: testuser@example.com
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.3038s ago] {'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.3034s ago] {'otp_code': '726382', 'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.3028s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
INFO     minila:log_service.py:63 Event logged: login_attempt
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
INFO     minila:email.py:49 Email sent successfully to testuser@example.com
INFO     minila:auth_service.py:138 OTP requested for: testuser@example.com
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.3089s ago] {'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.3084s ago] {'otp_code': '637487', 'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.3077s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
INFO     minila:log_service.py:63 Event logged: login_attempt
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
INFO     minila:email.py:49 Email sent successfully to testuser@example.com
INFO     minila:auth_service.py:138 OTP requested for: testuser@example.com
____________________ TestVerifyOTP.test_verify_otp_success _____________________
tests/api/test_auth.py:235: in test_verify_otp_success
    assert response.status_code == 200
E   assert 422 == 200
E    +  where 422 = <Response [422 Unprocessable Entity]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:50,276 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:50,276 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,276 INFO sqlalchemy.engine.Engine [cached since 0.4167s ago] {'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,277 INFO sqlalchemy.engine.Engine UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,277 INFO sqlalchemy.engine.Engine [cached since 0.4163s ago] {'otp_code': '534412', 'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,277 INFO sqlalchemy.engine.Engine INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
2025-11-02 15:56:50,277 INFO sqlalchemy.engine.Engine [cached since 0.4158s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
2025-11-02 15:56:50 - minila - INFO - Event logged: login_attempt
2025-11-02 15:56:50,278 INFO sqlalchemy.engine.Engine COMMIT
2025-11-02 15:56:50 - minila - INFO - Email sent successfully to testuser@example.com
2025-11-02 15:56:50 - minila - INFO - OTP requested for: testuser@example.com
2025-11-02 15:56:50 - minila - WARNING - Validation error: [{'type': 'string_type', 'loc': ('body', 'otp_code'), 'msg': 'Input should be a valid string', 'input': None}]
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.4167s ago] {'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.4163s ago] {'otp_code': '534412', 'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.4158s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
INFO     minila:log_service.py:63 Event logged: login_attempt
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
INFO     minila:email.py:49 Email sent successfully to testuser@example.com
INFO     minila:auth_service.py:138 OTP requested for: testuser@example.com
WARNING  minila:main.py:111 Validation error: [{'type': 'string_type', 'loc': ('body', 'otp_code'), 'msg': 'Input should be a valid string', 'input': None}]
___________________ TestVerifyOTP.test_verify_otp_used_code ____________________
tests/api/test_auth.py:293: in test_verify_otp_used_code
    assert response1.status_code == 200
E   assert 422 == 200
E    +  where 422 = <Response [422 Unprocessable Entity]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:50,493 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:50,493 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,493 INFO sqlalchemy.engine.Engine [cached since 0.634s ago] {'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,494 INFO sqlalchemy.engine.Engine UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,494 INFO sqlalchemy.engine.Engine [cached since 0.6335s ago] {'otp_code': '086401', 'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,494 INFO sqlalchemy.engine.Engine INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
2025-11-02 15:56:50,494 INFO sqlalchemy.engine.Engine [cached since 0.6328s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
2025-11-02 15:56:50 - minila - INFO - Event logged: login_attempt
2025-11-02 15:56:50,495 INFO sqlalchemy.engine.Engine COMMIT
2025-11-02 15:56:50 - minila - INFO - Email sent successfully to testuser@example.com
2025-11-02 15:56:50 - minila - INFO - OTP requested for: testuser@example.com
2025-11-02 15:56:50 - minila - WARNING - Validation error: [{'type': 'string_type', 'loc': ('body', 'otp_code'), 'msg': 'Input should be a valid string', 'input': None}]
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.634s ago] {'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.6335s ago] {'otp_code': '086401', 'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.6328s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
INFO     minila:log_service.py:63 Event logged: login_attempt
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
INFO     minila:email.py:49 Email sent successfully to testuser@example.com
INFO     minila:auth_service.py:138 OTP requested for: testuser@example.com
WARNING  minila:main.py:111 Validation error: [{'type': 'string_type', 'loc': ('body', 'otp_code'), 'msg': 'Input should be a valid string', 'input': None}]
_________________ TestRefreshToken.test_refresh_token_success __________________
tests/api/test_auth.py:361: in test_refresh_token_success
    refresh_token = tokens["refresh_token"]
E   KeyError: 'refresh_token'
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:50,791 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:50,791 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,791 INFO sqlalchemy.engine.Engine [cached since 0.9318s ago] {'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,792 INFO sqlalchemy.engine.Engine UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
2025-11-02 15:56:50,792 INFO sqlalchemy.engine.Engine [cached since 0.9313s ago] {'otp_code': '679233', 'email_1': 'testuser@example.com'}
2025-11-02 15:56:50,792 INFO sqlalchemy.engine.Engine INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
2025-11-02 15:56:50,792 INFO sqlalchemy.engine.Engine [cached since 0.9307s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
2025-11-02 15:56:50 - minila - INFO - Event logged: login_attempt
2025-11-02 15:56:50,793 INFO sqlalchemy.engine.Engine COMMIT
2025-11-02 15:56:50 - minila - INFO - Email sent successfully to testuser@example.com
2025-11-02 15:56:50 - minila - INFO - OTP requested for: testuser@example.com
2025-11-02 15:56:50 - minila - WARNING - Validation error: [{'type': 'string_type', 'loc': ('body', 'otp_code'), 'msg': 'Input should be a valid string', 'input': None}]
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.9318s ago] {'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 UPDATE "user" SET otp_code=%(otp_code)s::VARCHAR, updated_at=now() WHERE "user".email = %(email_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.9313s ago] {'otp_code': '679233', 'email_1': 'testuser@example.com'}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO log (event_type, ip, user_agent, payload, actor_user_id, target_user_id, card_id, community_id) VALUES (%(event_type)s::VARCHAR, %(ip)s::VARCHAR, %(user_agent)s::VARCHAR, %(payload)s::VARCHAR, %(actor_user_id)s::INTEGER, %(target_user_id)s::INTEGER, %(card_id)s::INTEGER, %(community_id)s::INTEGER) RETURNING log.id, log.created_at, log.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.9307s ago] {'event_type': 'login_attempt', 'ip': '127.0.0.1', 'user_agent': 'python-httpx/0.27.2', 'payload': '{"email": "testuser@example.com"}', 'actor_user_id': 4, 'target_user_id': None, 'card_id': None, 'community_id': None}
INFO     minila:log_service.py:63 Event logged: login_attempt
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
INFO     minila:email.py:49 Email sent successfully to testuser@example.com
INFO     minila:auth_service.py:138 OTP requested for: testuser@example.com
WARNING  minila:main.py:111 Validation error: [{'type': 'string_type', 'loc': ('body', 'otp_code'), 'msg': 'Input should be a valid string', 'input': None}]
______________ TestGetCards.test_get_cards_filter_is_sender_true _______________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
tests/api/test_cards.py:92: in test_get_cards_filter_is_sender_true
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 52, 6804), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 52, 6807), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
______________ TestCreateCard.test_create_passenger_card_success _______________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
E   DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:
tests/api/test_cards.py:168: in test_create_passenger_card_success
    response = await client.post(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1905: in post
    return await self.request(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1585: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1674: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1702: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1739: in _send_handling_redirects
    response = await self._send_single_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1776: in _send_single_request
    response = await transport.handle_async_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_transports/asgi.py:157: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
app/api/routers/cards.py:92: in create_card
    card = await card_service.create_card(
app/services/card_service.py:126: in create_card
    card = await card_repo.create(db, owner_id, **card_data)
app/repositories/card_repo.py:184: in create
    await db.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:787: in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
E   DETAIL:  Key (owner_id)=(1) is not present in table "user".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 824714), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Passenger card test'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:52,827 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:52,827 INFO sqlalchemy.engine.Engine INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at
2025-11-02 15:56:52,827 INFO sqlalchemy.engine.Engine [generated in 0.00007s] {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 824714), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Passenger card test'}
2025-11-02 15:56:52,828 INFO sqlalchemy.engine.Engine ROLLBACK
2025-11-02 15:56:52 - minila - ERROR - Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 824714), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Passenger card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/cards.py", line 92, in create_card
    card = await card_service.create_card(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/card_service.py", line 126, in create_card
    card = await card_repo.create(db, owner_id, **card_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/card_repo.py", line 184, in create
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 824714), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Passenger card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00007s] {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 824714), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Passenger card test'}
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
ERROR    minila:main.py:135 Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 824714), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Passenger card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/cards.py", line 92, in create_card
    card = await card_service.create_card(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/card_service.py", line 126, in create_card
    card = await card_repo.create(db, owner_id, **card_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/card_repo.py", line 184, in create
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 52, 824714), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Passenger card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
________________ TestCreateCard.test_create_sender_card_success ________________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
E   DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:
tests/api/test_cards.py:205: in test_create_sender_card_success
    response = await client.post(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1905: in post
    return await self.request(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1585: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1674: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1702: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1739: in _send_handling_redirects
    response = await self._send_single_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1776: in _send_single_request
    response = await transport.handle_async_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_transports/asgi.py:157: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
app/api/routers/cards.py:92: in create_card
    card = await card_service.create_card(
app/services/card_service.py:126: in create_card
    card = await card_repo.create(db, owner_id, **card_data)
app/repositories/card_repo.py:184: in create
    await db.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:787: in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
E   DETAIL:  Key (owner_id)=(1) is not present in table "user".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 53, 158348), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 53, 158353), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card test'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:53,159 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:53,159 INFO sqlalchemy.engine.Engine INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at
2025-11-02 15:56:53,159 INFO sqlalchemy.engine.Engine [cached since 0.3319s ago] {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 53, 158348), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 53, 158353), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card test'}
2025-11-02 15:56:53,160 INFO sqlalchemy.engine.Engine ROLLBACK
2025-11-02 15:56:53 - minila - ERROR - Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 53, 158348), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 53, 158353), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/cards.py", line 92, in create_card
    card = await card_service.create_card(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/card_service.py", line 126, in create_card
    card = await card_repo.create(db, owner_id, **card_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/card_repo.py", line 184, in create
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 53, 158348), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 53, 158353), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.3319s ago] {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 53, 158348), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 53, 158353), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card test'}
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
ERROR    minila:main.py:135 Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 53, 158348), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 53, 158353), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/cards.py", line 92, in create_card
    card = await card_service.create_card(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/card_service.py", line 126, in create_card
    card = await card_repo.create(db, owner_id, **card_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/card_repo.py", line 184, in create
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
[parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': True, 'start_time_frame': datetime.datetime(2025, 11, 3, 15, 56, 53, 158348), 'end_time_frame': datetime.datetime(2025, 11, 9, 15, 56, 53, 158353), 'ticket_date_time': None, 'weight': 10.0, 'is_packed': None, 'price_aed': None, 'description': 'Sender card test'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
___________________ TestDeleteCard.test_delete_card_by_owner ___________________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".

The above exception was the direct cause of the following exception:
tests/api/test_cards.py:450: in test_delete_card_by_owner
    await test_db.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "card" violates foreign key constraint "card_origin_country_id_fkey"
E   DETAIL:  Key (origin_country_id)=(1) is not present in table "country".
E   [SQL: INSERT INTO card (owner_id, origin_country_id, origin_city_id, destination_country_id, destination_city_id, product_classification_id, is_sender, start_time_frame, end_time_frame, ticket_date_time, weight, is_packed, price_aed, description) VALUES (%(owner_id)s::INTEGER, %(origin_country_id)s::INTEGER, %(origin_city_id)s::INTEGER, %(destination_country_id)s::INTEGER, %(destination_city_id)s::INTEGER, %(product_classification_id)s::INTEGER, %(is_sender)s, %(start_time_frame)s::TIMESTAMP WITH TIME ZONE, %(end_time_frame)s::TIMESTAMP WITH TIME ZONE, %(ticket_date_time)s::TIMESTAMP WITH TIME ZONE, %(weight)s, %(is_packed)s, %(price_aed)s, %(description)s::VARCHAR) RETURNING card.id, card.created_at, card.updated_at]
E   [parameters: {'owner_id': 1, 'origin_country_id': 1, 'origin_city_id': 1, 'destination_country_id': 2, 'destination_city_id': 2, 'product_classification_id': None, 'is_sender': False, 'start_time_frame': None, 'end_time_frame': None, 'ticket_date_time': datetime.datetime(2025, 11, 9, 15, 56, 55, 192223), 'weight': 5.0, 'is_packed': None, 'price_aed': None, 'description': 'Card to delete'}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
______________ TestCreateCommunity.test_create_community_success _______________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
E   DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:
tests/api/test_communities.py:88: in test_create_community_success
    response = await client.post(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1905: in post
    return await self.request(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1585: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1674: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1702: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1739: in _send_handling_redirects
    response = await self._send_single_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1776: in _send_single_request
    response = await transport.handle_async_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_transports/asgi.py:157: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
app/api/routers/communities.py:56: in create_community
    community = await community_service.create_community(
app/services/community_service.py:89: in create_community
    community = await community_repo.create(
app/repositories/community_repo.py:120: in create
    await db.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:787: in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
E   DETAIL:  Key (owner_id)=(1) is not present in table "user".
E   [SQL: INSERT INTO community (name, bio, avatar_id, owner_id) VALUES (%(name)s::VARCHAR, %(bio)s::VARCHAR, %(avatar_id)s::INTEGER, %(owner_id)s::INTEGER) RETURNING community.id, community.created_at, community.updated_at]
E   [parameters: {'name': 'New Community', 'bio': 'A brand new community for testing', 'avatar_id': None, 'owner_id': 1}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:56,475 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:56,475 INFO sqlalchemy.engine.Engine SELECT community.id 
FROM community 
WHERE community.name = %(name_1)s::VARCHAR
2025-11-02 15:56:56,475 INFO sqlalchemy.engine.Engine [generated in 0.00006s] {'name_1': 'New Community'}
2025-11-02 15:56:56,476 INFO sqlalchemy.engine.Engine INSERT INTO community (name, bio, avatar_id, owner_id) VALUES (%(name)s::VARCHAR, %(bio)s::VARCHAR, %(avatar_id)s::INTEGER, %(owner_id)s::INTEGER) RETURNING community.id, community.created_at, community.updated_at
2025-11-02 15:56:56,476 INFO sqlalchemy.engine.Engine [generated in 0.00006s] {'name': 'New Community', 'bio': 'A brand new community for testing', 'avatar_id': None, 'owner_id': 1}
2025-11-02 15:56:56,477 INFO sqlalchemy.engine.Engine ROLLBACK
2025-11-02 15:56:56 - minila - ERROR - Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO community (name, bio, avatar_id, owner_id) VALUES (%(name)s::VARCHAR, %(bio)s::VARCHAR, %(avatar_id)s::INTEGER, %(owner_id)s::INTEGER) RETURNING community.id, community.created_at, community.updated_at]
[parameters: {'name': 'New Community', 'bio': 'A brand new community for testing', 'avatar_id': None, 'owner_id': 1}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/communities.py", line 56, in create_community
    community = await community_service.create_community(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/community_service.py", line 89, in create_community
    community = await community_repo.create(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/community_repo.py", line 120, in create
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO community (name, bio, avatar_id, owner_id) VALUES (%(name)s::VARCHAR, %(bio)s::VARCHAR, %(avatar_id)s::INTEGER, %(owner_id)s::INTEGER) RETURNING community.id, community.created_at, community.updated_at]
[parameters: {'name': 'New Community', 'bio': 'A brand new community for testing', 'avatar_id': None, 'owner_id': 1}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT community.id 
FROM community 
WHERE community.name = %(name_1)s::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00006s] {'name_1': 'New Community'}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO community (name, bio, avatar_id, owner_id) VALUES (%(name)s::VARCHAR, %(bio)s::VARCHAR, %(avatar_id)s::INTEGER, %(owner_id)s::INTEGER) RETURNING community.id, community.created_at, community.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00006s] {'name': 'New Community', 'bio': 'A brand new community for testing', 'avatar_id': None, 'owner_id': 1}
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
ERROR    minila:main.py:135 Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO community (name, bio, avatar_id, owner_id) VALUES (%(name)s::VARCHAR, %(bio)s::VARCHAR, %(avatar_id)s::INTEGER, %(owner_id)s::INTEGER) RETURNING community.id, community.created_at, community.updated_at]
[parameters: {'name': 'New Community', 'bio': 'A brand new community for testing', 'avatar_id': None, 'owner_id': 1}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/communities.py", line 56, in create_community
    community = await community_service.create_community(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/community_service.py", line 89, in create_community
    community = await community_repo.create(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/community_repo.py", line 120, in create
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "community" violates foreign key constraint "community_owner_id_fkey"
DETAIL:  Key (owner_id)=(1) is not present in table "user".
[SQL: INSERT INTO community (name, bio, avatar_id, owner_id) VALUES (%(name)s::VARCHAR, %(bio)s::VARCHAR, %(avatar_id)s::INTEGER, %(owner_id)s::INTEGER) RETURNING community.id, community.created_at, community.updated_at]
[parameters: {'name': 'New Community', 'bio': 'A brand new community for testing', 'avatar_id': None, 'owner_id': 1}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
_______________ TestJoinCommunity.test_join_community_not_found ________________
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   psycopg.errors.ForeignKeyViolation: insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
E   DETAIL:  Key (user_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:
tests/api/test_communities.py:350: in test_join_community_not_found
    response = await client.post(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1905: in post
    return await self.request(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1585: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1674: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1702: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1739: in _send_handling_redirects
    response = await self._send_single_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1776: in _send_single_request
    response = await transport.handle_async_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_transports/asgi.py:157: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
app/api/routers/communities.py:168: in join_community
    request = await community_service.join_request(
app/services/community_service.py:197: in join_request
    request = await membership_repo.create_request(db, user_id, community_id)
app/repositories/membership_repo.py:119: in create_request
    await db.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:787: in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py:597: in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py:89: in execute
    raise ex.with_traceback(None)
E   sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
E   DETAIL:  Key (user_id)=(1) is not present in table "user".
E   [SQL: INSERT INTO request (user_id, community_id, is_approved) VALUES (%(user_id)s::INTEGER, %(community_id)s::INTEGER, %(is_approved)s) RETURNING request.id, request.created_at, request.updated_at]
E   [parameters: {'user_id': 1, 'community_id': 99999, 'is_approved': None}]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:58,084 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:58,085 INFO sqlalchemy.engine.Engine SELECT membership.user_id, membership.community_id, membership.role_id, membership.is_active, membership.id, membership.created_at, membership.updated_at 
FROM membership 
WHERE membership.user_id = %(user_id_1)s::INTEGER AND membership.community_id = %(community_id_1)s::INTEGER
2025-11-02 15:56:58,085 INFO sqlalchemy.engine.Engine [generated in 0.00006s] {'user_id_1': 1, 'community_id_1': 99999}
2025-11-02 15:56:58,086 INFO sqlalchemy.engine.Engine SELECT request.id 
FROM request 
WHERE request.user_id = %(user_id_1)s::INTEGER AND request.community_id = %(community_id_1)s::INTEGER AND request.is_approved IS NULL
2025-11-02 15:56:58,086 INFO sqlalchemy.engine.Engine [generated in 0.00005s] {'user_id_1': 1, 'community_id_1': 99999}
2025-11-02 15:56:58,087 INFO sqlalchemy.engine.Engine INSERT INTO request (user_id, community_id, is_approved) VALUES (%(user_id)s::INTEGER, %(community_id)s::INTEGER, %(is_approved)s) RETURNING request.id, request.created_at, request.updated_at
2025-11-02 15:56:58,087 INFO sqlalchemy.engine.Engine [generated in 0.00006s] {'user_id': 1, 'community_id': 99999, 'is_approved': None}
2025-11-02 15:56:58,087 INFO sqlalchemy.engine.Engine ROLLBACK
2025-11-02 15:56:58 - minila - ERROR - Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
DETAIL:  Key (user_id)=(1) is not present in table "user".
[SQL: INSERT INTO request (user_id, community_id, is_approved) VALUES (%(user_id)s::INTEGER, %(community_id)s::INTEGER, %(is_approved)s) RETURNING request.id, request.created_at, request.updated_at]
[parameters: {'user_id': 1, 'community_id': 99999, 'is_approved': None}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
DETAIL:  Key (user_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/communities.py", line 168, in join_community
    request = await community_service.join_request(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/community_service.py", line 197, in join_request
    request = await membership_repo.create_request(db, user_id, community_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/membership_repo.py", line 119, in create_request
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
DETAIL:  Key (user_id)=(1) is not present in table "user".
[SQL: INSERT INTO request (user_id, community_id, is_approved) VALUES (%(user_id)s::INTEGER, %(community_id)s::INTEGER, %(is_approved)s) RETURNING request.id, request.created_at, request.updated_at]
[parameters: {'user_id': 1, 'community_id': 99999, 'is_approved': None}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT membership.user_id, membership.community_id, membership.role_id, membership.is_active, membership.id, membership.created_at, membership.updated_at 
FROM membership 
WHERE membership.user_id = %(user_id_1)s::INTEGER AND membership.community_id = %(community_id_1)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00006s] {'user_id_1': 1, 'community_id_1': 99999}
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT request.id 
FROM request 
WHERE request.user_id = %(user_id_1)s::INTEGER AND request.community_id = %(community_id_1)s::INTEGER AND request.is_approved IS NULL
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00005s] {'user_id_1': 1, 'community_id_1': 99999}
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO request (user_id, community_id, is_approved) VALUES (%(user_id)s::INTEGER, %(community_id)s::INTEGER, %(is_approved)s) RETURNING request.id, request.created_at, request.updated_at
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00006s] {'user_id': 1, 'community_id': 99999, 'is_approved': None}
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
ERROR    minila:main.py:135 Unhandled exception: (psycopg.errors.ForeignKeyViolation) insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
DETAIL:  Key (user_id)=(1) is not present in table "user".
[SQL: INSERT INTO request (user_id, community_id, is_approved) VALUES (%(user_id)s::INTEGER, %(community_id)s::INTEGER, %(is_approved)s) RETURNING request.id, request.created_at, request.updated_at]
[parameters: {'user_id': 1, 'community_id': 99999, 'is_approved': None}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
psycopg.errors.ForeignKeyViolation: insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
DETAIL:  Key (user_id)=(1) is not present in table "user".

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/routers/communities.py", line 168, in join_community
    request = await community_service.join_request(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/services/community_service.py", line 197, in join_request
    request = await membership_repo.create_request(db, user_id, community_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/repositories/membership_repo.py", line 119, in create_request
    await db.flush()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/cursor_async.py", line 89, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "request" violates foreign key constraint "request_user_id_fkey"
DETAIL:  Key (user_id)=(1) is not present in table "user".
[SQL: INSERT INTO request (user_id, community_id, is_approved) VALUES (%(user_id)s::INTEGER, %(community_id)s::INTEGER, %(is_approved)s) RETURNING request.id, request.created_at, request.updated_at]
[parameters: {'user_id': 1, 'community_id': 99999, 'is_approved': None}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
______________ TestGetCommunityMembers.test_get_members_not_found ______________
tests/api/test_communities.py:661: in test_get_members_not_found
    assert response.status_code == 404
E   assert 200 == 404
E    +  where 200 = <Response [200 OK]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:56:59,987 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:56:59,988 INFO sqlalchemy.engine.Engine SELECT count(membership.id) AS count_1 
FROM membership 
WHERE membership.community_id = %(community_id_1)s::INTEGER AND membership.is_active = true
2025-11-02 15:56:59,988 INFO sqlalchemy.engine.Engine [generated in 0.00008s] {'community_id_1': 99999}
2025-11-02 15:56:59,989 INFO sqlalchemy.engine.Engine SELECT membership.user_id, membership.community_id, membership.role_id, membership.is_active, membership.id, membership.created_at, membership.updated_at 
FROM membership 
WHERE membership.community_id = %(community_id_1)s::INTEGER AND membership.is_active = true ORDER BY membership.created_at DESC 
 LIMIT %(param_1)s::INTEGER OFFSET %(param_2)s::INTEGER
2025-11-02 15:56:59,989 INFO sqlalchemy.engine.Engine [generated in 0.00006s] {'community_id_1': 99999, 'param_1': 20, 'param_2': 0}
2025-11-02 15:56:59,990 INFO sqlalchemy.engine.Engine COMMIT
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT count(membership.id) AS count_1 
FROM membership 
WHERE membership.community_id = %(community_id_1)s::INTEGER AND membership.is_active = true
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00008s] {'community_id_1': 99999}
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT membership.user_id, membership.community_id, membership.role_id, membership.is_active, membership.id, membership.created_at, membership.updated_at 
FROM membership 
WHERE membership.community_id = %(community_id_1)s::INTEGER AND membership.is_active = true ORDER BY membership.created_at DESC 
 LIMIT %(param_1)s::INTEGER OFFSET %(param_2)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00006s] {'community_id_1': 99999, 'param_1': 20, 'param_2': 0}
INFO     sqlalchemy.engine.Engine:base.py:2708 COMMIT
_______ TestSendMessage.test_send_message_validation_error_missing_body ________
tests/api/test_messages.py:161: in test_send_message_validation_error_missing_body
    response = await client.post(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1905: in post
    return await self.request(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1585: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1674: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1702: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1739: in _send_handling_redirects
    response = await self._send_single_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1776: in _send_single_request
    response = await transport.handle_async_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_transports/asgi.py:157: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
app/api/deps.py:118: in verify_message_rate_limit
    await check_rate_limit(
app/core/rate_limit.py:135: in check_rate_limit
    limiter = get_rate_limiter()
app/core/rate_limit.py:114: in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
E   RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:00 - minila - ERROR - Unhandled exception: Rate limiter not initialized. Call init_rate_limiter() first.
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/deps.py", line 118, in verify_message_rate_limit
    await check_rate_limit(
  File "/app/app/core/rate_limit.py", line 135, in check_rate_limit
    limiter = get_rate_limiter()
              ^^^^^^^^^^^^^^^^^^
  File "/app/app/core/rate_limit.py", line 114, in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
------------------------------ Captured log call -------------------------------
ERROR    minila:main.py:135 Unhandled exception: Rate limiter not initialized. Call init_rate_limiter() first.
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/deps.py", line 118, in verify_message_rate_limit
    await check_rate_limit(
  File "/app/app/core/rate_limit.py", line 135, in check_rate_limit
    limiter = get_rate_limiter()
              ^^^^^^^^^^^^^^^^^^
  File "/app/app/core/rate_limit.py", line 114, in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
________ TestSendMessage.test_send_message_validation_error_empty_body _________
tests/api/test_messages.py:184: in test_send_message_validation_error_empty_body
    response = await client.post(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1905: in post
    return await self.request(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1585: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1674: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1702: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1739: in _send_handling_redirects
    response = await self._send_single_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1776: in _send_single_request
    response = await transport.handle_async_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_transports/asgi.py:157: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
app/api/deps.py:118: in verify_message_rate_limit
    await check_rate_limit(
app/core/rate_limit.py:135: in check_rate_limit
    limiter = get_rate_limiter()
app/core/rate_limit.py:114: in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
E   RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:00 - minila - ERROR - Unhandled exception: Rate limiter not initialized. Call init_rate_limiter() first.
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/deps.py", line 118, in verify_message_rate_limit
    await check_rate_limit(
  File "/app/app/core/rate_limit.py", line 135, in check_rate_limit
    limiter = get_rate_limiter()
              ^^^^^^^^^^^^^^^^^^
  File "/app/app/core/rate_limit.py", line 114, in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
------------------------------ Captured log call -------------------------------
ERROR    minila:main.py:135 Unhandled exception: Rate limiter not initialized. Call init_rate_limiter() first.
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/deps.py", line 118, in verify_message_rate_limit
    await check_rate_limit(
  File "/app/app/core/rate_limit.py", line 135, in check_rate_limit
    limiter = get_rate_limiter()
              ^^^^^^^^^^^^^^^^^^
  File "/app/app/core/rate_limit.py", line 114, in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
____________ TestSendMessage.test_send_message_to_nonexistent_user _____________
tests/api/test_messages.py:211: in test_send_message_to_nonexistent_user
    response = await client.post(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1905: in post
    return await self.request(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1585: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1674: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1702: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1739: in _send_handling_redirects
    response = await self._send_single_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_client.py:1776: in _send_single_request
    response = await transport.handle_async_request(request)
/usr/local/lib/python3.12/site-packages/httpx/_transports/asgi.py:157: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
/usr/local/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
app/api/deps.py:118: in verify_message_rate_limit
    await check_rate_limit(
app/core/rate_limit.py:135: in check_rate_limit
    limiter = get_rate_limiter()
app/core/rate_limit.py:114: in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
E   RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:00 - minila - ERROR - Unhandled exception: Rate limiter not initialized. Call init_rate_limiter() first.
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/deps.py", line 118, in verify_message_rate_limit
    await check_rate_limit(
  File "/app/app/core/rate_limit.py", line 135, in check_rate_limit
    limiter = get_rate_limiter()
              ^^^^^^^^^^^^^^^^^^
  File "/app/app/core/rate_limit.py", line 114, in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
------------------------------ Captured log call -------------------------------
ERROR    minila:main.py:135 Unhandled exception: Rate limiter not initialized. Call init_rate_limiter() first.
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/api/deps.py", line 118, in verify_message_rate_limit
    await check_rate_limit(
  File "/app/app/core/rate_limit.py", line 135, in check_rate_limit
    limiter = get_rate_limiter()
              ^^^^^^^^^^^^^^^^^^
  File "/app/app/core/rate_limit.py", line 114, in get_rate_limiter
    raise RuntimeError("Rate limiter not initialized. Call init_rate_limiter() first.")
RuntimeError: Rate limiter not initialized. Call init_rate_limiter() first.
__________________ TestGetMyProfile.test_get_profile_success ___________________
tests/api/test_users.py:24: in test_get_profile_success
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:02,053 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:57:02,083 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
2025-11-02 15:57:02,083 INFO sqlalchemy.engine.Engine [generated in 0.00018s] {'id_1': 1}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00018s] {'id_1': 1}
--------------------------- Captured stdout teardown ---------------------------
2025-11-02 15:57:02,085 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown -----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
______________ TestUpdateMyProfile.test_update_profile_all_fields ______________
tests/api/test_users.py:87: in test_update_profile_all_fields
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:02,385 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:57:02,386 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
2025-11-02 15:57:02,386 INFO sqlalchemy.engine.Engine [cached since 0.303s ago] {'id_1': 1}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.303s ago] {'id_1': 1}
--------------------------- Captured stdout teardown ---------------------------
2025-11-02 15:57:02,388 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown -----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
_______________ TestUpdateMyProfile.test_update_profile_partial ________________
tests/api/test_users.py:115: in test_update_profile_partial
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:02,492 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:57:02,492 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
2025-11-02 15:57:02,492 INFO sqlalchemy.engine.Engine [cached since 0.4097s ago] {'id_1': 1}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.4097s ago] {'id_1': 1}
--------------------------- Captured stdout teardown ---------------------------
2025-11-02 15:57:02,494 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown -----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
___________ TestUpdateMyProfile.test_update_profile_check_updated_at ___________
tests/api/test_users.py:183: in test_update_profile_check_updated_at
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:02,789 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:57:02,789 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
2025-11-02 15:57:02,789 INFO sqlalchemy.engine.Engine [cached since 0.7069s ago] {'id_1': 1}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.7069s ago] {'id_1': 1}
--------------------------- Captured stdout teardown ---------------------------
2025-11-02 15:57:02,791 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown -----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
____________ TestUpdateMyProfile.test_update_profile_empty_payload _____________
tests/api/test_users.py:209: in test_update_profile_empty_payload
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:02,893 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:57:02,893 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
2025-11-02 15:57:02,893 INFO sqlalchemy.engine.Engine [cached since 0.8108s ago] {'id_1': 1}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.8108s ago] {'id_1': 1}
--------------------------- Captured stdout teardown ---------------------------
2025-11-02 15:57:02,896 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown -----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
___________ TestUpdateMyProfile.test_update_profile_with_null_values ___________
tests/api/test_users.py:237: in test_update_profile_with_null_values
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
----------------------------- Captured stdout call -----------------------------
2025-11-02 15:57:02,999 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-02 15:57:02,999 INFO sqlalchemy.engine.Engine SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
2025-11-02 15:57:02,999 INFO sqlalchemy.engine.Engine [cached since 0.9167s ago] {'id_1': 1}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".email, "user".first_name, "user".last_name, "user".password, "user".otp_code, "user".national_id, "user".gender, "user".birthday, "user".postal_code, "user".is_active, "user".is_admin, "user".avatar_id, "user".country_id, "user".city_id, "user".id, "user".created_at, "user".updated_at 
FROM "user" 
WHERE "user".id = %(id_1)s::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.9167s ago] {'id_1': 1}
--------------------------- Captured stdout teardown ---------------------------
2025-11-02 15:57:03,001 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown -----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
=============================== warnings summary ===============================
../usr/local/lib/python3.12/site-packages/pydantic/_internal/_config.py:291
  /usr/local/lib/python3.12/site-packages/pydantic/_internal/_config.py:291: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.8/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/api/test_auth.py: 8 warnings
tests/api/test_cards.py: 19 warnings
tests/api/test_communities.py: 26 warnings
tests/api/test_messages.py: 21 warnings
tests/api/test_users.py: 7 warnings
  /app/app/core/security.py:106: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + timedelta(minutes=expires_minutes)

tests/api/test_auth.py: 1 warning
tests/api/test_cards.py: 5 warnings
tests/api/test_communities.py: 4 warnings
tests/api/test_messages.py: 3 warnings
tests/api/test_users.py: 7 warnings
  /app/app/core/security.py:180: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    if datetime.utcnow().timestamp() > payload["exp"]:

tests/api/test_cards.py: 11 warnings
  /app/tests/conftest.py:369: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    ticket_date_time=datetime.utcnow() + timedelta(days=7),

tests/api/test_cards.py::TestGetCards::test_get_cards_filter_is_sender_true
  /app/tests/api/test_cards.py:86: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    start_time_frame=datetime.utcnow() + timedelta(days=1),

tests/api/test_cards.py::TestGetCards::test_get_cards_filter_is_sender_true
  /app/tests/api/test_cards.py:87: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    end_time_frame=datetime.utcnow() + timedelta(days=7),

tests/api/test_cards.py::TestCreateCard::test_create_passenger_card_success
  /app/tests/api/test_cards.py:162: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "ticket_date_time": (datetime.utcnow() + timedelta(days=7)).isoformat(),

tests/api/test_cards.py::TestCreateCard::test_create_sender_card_success
  /app/tests/api/test_cards.py:198: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "start_time_frame": (datetime.utcnow() + timedelta(days=1)).isoformat(),

tests/api/test_cards.py::TestCreateCard::test_create_sender_card_success
  /app/tests/api/test_cards.py:199: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "end_time_frame": (datetime.utcnow() + timedelta(days=7)).isoformat(),

tests/api/test_cards.py::TestCreateCard::test_create_card_without_auth
  /app/tests/api/test_cards.py:227: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "ticket_date_time": (datetime.utcnow() + timedelta(days=7)).isoformat(),

tests/api/test_cards.py::TestDeleteCard::test_delete_card_by_owner
  /app/tests/api/test_cards.py:445: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    ticket_date_time=datetime.utcnow() + timedelta(days=7),

tests/api/test_messages.py::TestSendMessage::test_send_message_to_nonexistent_user
  /app/tests/conftest.py:75: DeprecationWarning: Call to deprecated close. (Use aclose() instead) -- Deprecated since version 5.0.1.
    await client.close()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/api/test_auth.py::TestSignup::test_signup_success - assert 400 =...
FAILED tests/api/test_auth.py::TestRequestOTP::test_request_otp_success - ass...
FAILED tests/api/test_auth.py::TestRequestOTP::test_request_otp_updates_existing_code
FAILED tests/api/test_auth.py::TestVerifyOTP::test_verify_otp_success - asser...
FAILED tests/api/test_auth.py::TestVerifyOTP::test_verify_otp_used_code - ass...
FAILED tests/api/test_auth.py::TestRefreshToken::test_refresh_token_success
FAILED tests/api/test_cards.py::TestGetCards::test_get_cards_filter_is_sender_true
FAILED tests/api/test_cards.py::TestCreateCard::test_create_passenger_card_success
FAILED tests/api/test_cards.py::TestCreateCard::test_create_sender_card_success
FAILED tests/api/test_cards.py::TestDeleteCard::test_delete_card_by_owner - s...
FAILED tests/api/test_communities.py::TestCreateCommunity::test_create_community_success
FAILED tests/api/test_communities.py::TestJoinCommunity::test_join_community_not_found
FAILED tests/api/test_communities.py::TestGetCommunityMembers::test_get_members_not_found
FAILED tests/api/test_messages.py::TestSendMessage::test_send_message_validation_error_missing_body
FAILED tests/api/test_messages.py::TestSendMessage::test_send_message_validation_error_empty_body
FAILED tests/api/test_messages.py::TestSendMessage::test_send_message_to_nonexistent_user
FAILED tests/api/test_users.py::TestGetMyProfile::test_get_profile_success - ...
FAILED tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_all_fields
FAILED tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_partial
FAILED tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_check_updated_at
FAILED tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_empty_payload
FAILED tests/api/test_users.py::TestUpdateMyProfile::test_update_profile_with_null_values
ERROR tests/api/test_cards.py::TestGetCards::test_get_cards_with_pagination
ERROR tests/api/test_cards.py::TestGetCards::test_get_cards_filter_origin_city
ERROR tests/api/test_cards.py::TestGetCards::test_get_cards_filter_destination_city
ERROR tests/api/test_cards.py::TestGetCards::test_get_cards_filter_is_sender_false
ERROR tests/api/test_cards.py::TestGetCards::test_get_cards_multiple_filters
ERROR tests/api/test_cards.py::TestCreateCard::test_create_card_with_community_ids
ERROR tests/api/test_cards.py::TestGetCard::test_get_card_success - sqlalchem...
ERROR tests/api/test_cards.py::TestUpdateCard::test_update_card_by_owner - sq...
ERROR tests/api/test_cards.py::TestUpdateCard::test_update_card_by_non_owner
ERROR tests/api/test_cards.py::TestUpdateCard::test_update_card_without_auth
ERROR tests/api/test_cards.py::TestDeleteCard::test_delete_card_by_non_owner
ERROR tests/api/test_cards.py::TestDeleteCard::test_delete_card_without_auth
ERROR tests/api/test_communities.py::TestGetCommunities::test_get_communities_with_data
ERROR tests/api/test_communities.py::TestGetCommunities::test_get_communities_pagination
ERROR tests/api/test_communities.py::TestCreateCommunity::test_create_community_duplicate_name
ERROR tests/api/test_communities.py::TestGetCommunity::test_get_community_success
ERROR tests/api/test_communities.py::TestUpdateCommunity::test_update_community_by_owner
ERROR tests/api/test_communities.py::TestUpdateCommunity::test_update_community_by_non_owner
ERROR tests/api/test_communities.py::TestUpdateCommunity::test_update_community_without_auth
ERROR tests/api/test_communities.py::TestJoinCommunity::test_join_community_success
ERROR tests/api/test_communities.py::TestJoinCommunity::test_join_community_duplicate_request
ERROR tests/api/test_communities.py::TestJoinCommunity::test_join_community_without_auth
ERROR tests/api/test_communities.py::TestGetJoinRequests::test_get_requests_by_owner
ERROR tests/api/test_communities.py::TestGetJoinRequests::test_get_requests_by_non_owner
ERROR tests/api/test_communities.py::TestGetJoinRequests::test_get_requests_without_auth
ERROR tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_success
ERROR tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_by_non_owner
ERROR tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_not_found
ERROR tests/api/test_communities.py::TestApproveJoinRequest::test_approve_request_without_auth
ERROR tests/api/test_communities.py::TestRejectJoinRequest::test_reject_request_success
ERROR tests/api/test_communities.py::TestRejectJoinRequest::test_reject_request_by_non_owner
ERROR tests/api/test_communities.py::TestRejectJoinRequest::test_reject_request_without_auth
ERROR tests/api/test_communities.py::TestGetCommunityMembers::test_get_members_with_pagination
ERROR tests/api/test_communities.py::TestGetCommunityMembers::test_get_members_only_active
ERROR tests/api/test_messages.py::TestSendMessage::test_send_message_success_with_common_community
ERROR tests/api/test_messages.py::TestSendMessage::test_send_message_blocked_no_common_community
ERROR tests/api/test_messages.py::TestSendMessage::test_send_message_rate_limit_exceeded
ERROR tests/api/test_messages.py::TestGetInbox::test_get_inbox_with_messages
ERROR tests/api/test_messages.py::TestGetInbox::test_get_inbox_only_received_messages
ERROR tests/api/test_messages.py::TestGetInbox::test_get_inbox_newest_first
ERROR tests/api/test_messages.py::TestGetSent::test_get_sent_with_messages - ...
ERROR tests/api/test_messages.py::TestGetSent::test_get_sent_only_sent_messages
ERROR tests/api/test_messages.py::TestGetSent::test_get_sent_newest_first - I...
=========== 22 failed, 28 passed, 121 warnings, 43 errors in 13.92s ============

